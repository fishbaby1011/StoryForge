---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import ContinueReading from "@/components/Novel/ContinueReading.astro";
import TableOfContents from "@/components/Novel/TableOfContents.astro";
import { sortChapters, toChapterUrl, VOLUME_NAMES, type NovelEntry } from "@/lib/novel";

const chapters = (await getCollection("novel")).sort(sortChapters);
const firstChapter = chapters[0];
const grouped = chapters.reduce<Record<number, NovelEntry[]>>((acc, entry) => {
  const key = entry.data.volume;
  if (!acc[key]) {
    acc[key] = [];
  }
  acc[key].push(entry);
  return acc;
}, {});
---

<BaseLayout title="Novel Catalog" description="All available chapters.">
  <section class="space-y-8">
    <div class="space-y-3">
      <h1 class="text-3xl font-semibold">Catalog</h1>
      <p class="text-muted">Choose a chapter or continue where you left off.</p>
      {firstChapter && <ContinueReading fallbackHref={toChapterUrl(firstChapter)} />}
    </div>

    {
      Object.entries(grouped).map(([volume, volumeChapters]) => (
        <section class="space-y-3">
          <h2 class="font-ui text-sm uppercase tracking-[0.15em] text-muted">
            {VOLUME_NAMES[Number(volume)] ?? `Volume ${volume}`}
          </h2>
          {volumeChapters && <TableOfContents chapters={volumeChapters} />}
        </section>
      ))
    }
  </section>
</BaseLayout>
